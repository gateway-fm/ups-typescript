openapi: 3.0.0
info:
  title: x402 UPS API
  version: 1.0.0
  description: x402 Universal Payments SDK API
paths:
  /health:
    get:
      summary: Health check
      operationId: healthCheck
      tags:
        - Health
      responses:
        "200":
          description: Service is healthy
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/HealthResponse"
  /auth/connect:
    post:
      summary: Connect (unified auth) - creates user if new, authenticates if existing
      operationId: connectUser
      tags:
        - Auth
      requestBody:
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/ConnectRequest"
        required: true
      responses:
        "200":
          description: Existing user authenticated
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ConnectResponse"
        "201":
          description: New user created and authenticated
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ConnectResponse"
        "401":
          description: Authentication failed
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
  /auth/refresh:
    post:
      summary: Refresh session token
      description: Returns a new session token with extended expiry. Requires valid
        existing token.
      operationId: refreshToken
      tags:
        - Auth
      security:
        - BearerAuth: []
      responses:
        "200":
          description: Token refreshed successfully
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/RefreshResponse"
        "401":
          description: Invalid or expired token
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
  /auth/register:
    post:
      summary: Register new user with wallet (deprecated - use /auth/connect)
      operationId: registerUser
      deprecated: true
      tags:
        - Auth
      requestBody:
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/RegisterRequest"
        required: true
      responses:
        "201":
          description: User registered
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/AuthResponse"
        "400":
          description: Invalid input
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
  /auth/login:
    post:
      summary: Authenticate with wallet signature (deprecated - use /auth/connect)
      operationId: loginUser
      deprecated: true
      tags:
        - Auth
      requestBody:
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/LoginRequest"
        required: true
      responses:
        "200":
          description: Authentication successful
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/AuthResponse"
        "401":
          description: Authentication failed
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
  /users/me:
    get:
      summary: Get current user
      operationId: getCurrentUser
      tags:
        - Users
      security:
        - BearerAuth: []
      responses:
        "200":
          description: User details
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/UserResponse"
        "401":
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
  /accounts:
    post:
      summary: Create SmartAccount
      description: >
        Creates a new Smart Account for the authenticated user. 

        Users can create multiple accounts using different salts - each unique owner+salt combination 

        produces a distinct account address. If an account with the same owner+salt already exists, 

        the existing account is returned (idempotent behavior).
      operationId: createAccount
      tags:
        - Accounts
      security:
        - BearerAuth: []
      requestBody:
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/CreateAccountRequest"
        required: true
      responses:
        "201":
          description: Account created
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/AccountResponse"
        "400":
          description: Invalid input
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
        "401":
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
    get:
      summary: List user accounts
      operationId: listAccounts
      tags:
        - Accounts
      security:
        - BearerAuth: []
      responses:
        "200":
          description: List of accounts
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/AccountListResponse"
        "401":
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
  "/accounts/{id}":
    get:
      summary: Get account by ID
      operationId: getAccount
      tags:
        - Accounts
      security:
        - BearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        "200":
          description: Account details
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/AccountResponse"
        "401":
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
        "404":
          description: Account not found
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
  /accounts/predict:
    post:
      summary: Predict SmartAccount address
      operationId: predictAccountAddress
      tags:
        - Accounts
      security:
        - BearerAuth: []
      requestBody:
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/PredictAddressRequest"
        required: true
      responses:
        "200":
          description: Predicted address
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/PredictAddressResponse"
        "400":
          description: Invalid input
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
        "401":
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
  /invoices:
    post:
      summary: Create new invoice
      operationId: createInvoice
      tags:
        - Invoices
      security:
        - BearerAuth: []
      requestBody:
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/CreateInvoiceRequest"
        required: true
      responses:
        "201":
          description: Invoice created
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/InvoiceResponse"
        "400":
          description: Invalid input
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
        "401":
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
    get:
      summary: List invoices
      operationId: listInvoices
      tags:
        - Invoices
      parameters:
        - name: merchant
          in: query
          description: Filter by merchant address (0x-prefixed)
          schema:
            type: string
        - name: payer
          in: query
          description: Filter by payer address (0x-prefixed)
          schema:
            type: string
        - name: page_size
          in: query
          schema:
            type: integer
            default: 10
        - name: page_token
          in: query
          schema:
            type: string
      responses:
        "200":
          description: List of invoices
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/InvoiceListResponse"
        "400":
          description: Invalid parameters
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
  "/invoices/{id}":
    get:
      summary: Get invoice by ID
      operationId: getInvoice
      tags:
        - Invoices
      parameters:
        - name: id
          in: path
          required: true
          description: Invoice ID
          schema:
            type: string
      responses:
        "200":
          description: Invoice details
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/InvoiceResponse"
        "404":
          description: Invoice not found
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
  "/invoices/{id}/cancel":
    post:
      summary: Cancel invoice
      operationId: cancelInvoice
      tags:
        - Invoices
      security:
        - BearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          description: Invoice ID
          schema:
            type: string
      responses:
        "200":
          description: Invoice cancelled
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/InvoiceResponse"
        "401":
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
        "403":
          description: Forbidden (Not invoice creator)
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
        "404":
          description: Invoice not found
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
  /x402/verify:
    post:
      summary: Verify payment signature
      operationId: x402Verify
      tags:
        - x402
      requestBody:
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/X402VerifyRequest"
        required: true
      responses:
        "200":
          description: Verification result
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/X402VerifyResponse"
        "400":
          description: Invalid input
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
  /x402/settle:
    post:
      summary: Settle payment on-chain
      operationId: x402Settle
      tags:
        - x402
      requestBody:
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/X402SettleRequest"
        required: true
      responses:
        "200":
          description: Settlement result
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/X402SettleResponse"
        "400":
          description: Invalid input
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
  /x402/supported:
    get:
      summary: Get supported payment schemes
      operationId: x402GetSupported
      tags:
        - x402
      responses:
        "200":
          description: Supported schemes
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/X402SupportedResponse"
  "/x402/escrow/{escrowId}":
    get:
      summary: Get escrow details
      operationId: getEscrow
      tags:
        - x402
        - Escrow
      parameters:
        - name: escrowId
          in: path
          required: true
          description: Escrow ID (hex string)
          schema:
            type: string
      responses:
        "200":
          description: Escrow details
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/GetEscrowResponse"
        "404":
          description: Escrow not found
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
  "/x402/escrow/{escrowId}/release":
    post:
      summary: Release escrow funds
      operationId: releaseEscrow
      tags:
        - x402
        - Escrow
      security:
        - BearerAuth: []
      parameters:
        - name: escrowId
          in: path
          required: true
          schema:
            type: string
      requestBody:
        $ref: "#/components/requestBodies/EscrowActionRequest"
      responses:
        "200":
          description: Release result
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/EscrowActionResponse"
        "401":
          description: Unauthorized
        "403":
          description: Forbidden (Not arbiter)
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
  "/x402/escrow/{escrowId}/refund":
    post:
      summary: Refund escrow funds
      operationId: refundEscrow
      tags:
        - x402
        - Escrow
      security:
        - BearerAuth: []
      parameters:
        - name: escrowId
          in: path
          required: true
          schema:
            type: string
      requestBody:
        $ref: "#/components/requestBodies/EscrowActionRequest"
      responses:
        "200":
          description: Refund result
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/EscrowActionResponse"
        "401":
          description: Unauthorized
        "403":
          description: Forbidden (Not arbiter)
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
servers:
  - url: /api/v1
components:
  requestBodies:
    EscrowActionRequest:
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/EscrowActionRequest"
  securitySchemes:
    BearerAuth:
      type: apiKey
      name: Authorization
      in: header
  schemas:
    HealthResponse:
      type: object
      properties:
        status:
          type: string
        timestamp:
          type: string
          format: date-time
    RegisterRequest:
      type: object
      required:
        - wallet_address
        - signature
        - message
      properties:
        wallet_address:
          type: string
          description: 0x-prefixed Ethereum address
        signature:
          type: string
          description: 0x-prefixed EIP-191 signature
        message:
          type: string
    LoginRequest:
      type: object
      required:
        - wallet_address
        - signature
        - message
      properties:
        wallet_address:
          type: string
        signature:
          type: string
        message:
          type: string
    ConnectRequest:
      type: object
      required:
        - wallet_address
        - signature
        - message
      properties:
        wallet_address:
          type: string
          description: 0x-prefixed Ethereum address
        signature:
          type: string
          description: 0x-prefixed EIP-191 signature
        message:
          type: string
    ConnectResponse:
      type: object
      properties:
        user:
          $ref: "#/components/schemas/User"
        token:
          type: string
        expires_at:
          type: string
          format: date-time
        is_new_user:
          type: boolean
          description: True if a new user was created, false if existing user was
            authenticated
    AuthResponse:
      type: object
      properties:
        user:
          $ref: "#/components/schemas/User"
        token:
          type: string
        expires_at:
          type: string
          format: date-time
    RefreshResponse:
      type: object
      properties:
        token:
          type: string
          description: New JWT token
        expires_at:
          type: string
          format: date-time
          description: Token expiration time
    User:
      type: object
      properties:
        id:
          type: string
          format: uuid
        wallet_address:
          type: string
        status:
          type: string
        created_at:
          type: string
          format: date-time
    UserResponse:
      type: object
      properties:
        user:
          $ref: "#/components/schemas/User"
    CreateAccountRequest:
      type: object
      required:
        - owner_address
        - salt
      properties:
        owner_address:
          type: string
          description: 0x-prefixed EOA address that will own the Smart Account
        salt:
          type: string
          description: 0x-prefixed 32-byte salt. Different salts allow creation of
            multiple accounts for the same owner. Same owner+salt combination is
            idempotent.
    Account:
      type: object
      properties:
        id:
          type: string
          format: uuid
        owner_address:
          type: string
        wallet_address:
          type: string
        status:
          type: string
        kyc_level:
          type: integer
        user_id:
          type: string
          format: uuid
        created_at:
          type: string
          format: date-time
    AccountResponse:
      type: object
      properties:
        account:
          $ref: "#/components/schemas/Account"
        tx_hash:
          type: string
    AccountListResponse:
      type: object
      properties:
        accounts:
          type: array
          items:
            $ref: "#/components/schemas/Account"
    PredictAddressRequest:
      type: object
      required:
        - owner_address
        - salt
      properties:
        owner_address:
          type: string
        salt:
          type: string
    PredictAddressResponse:
      type: object
      properties:
        wallet_address:
          type: string
    PaymentType:
      type: string
      enum:
        - UNSPECIFIED
        - DIRECT
        - ESCROW
        - INVOICE
    PaymentExtra:
      type: object
      properties:
        name:
          type: string
        version:
          type: string
        payment_type:
          $ref: "#/components/schemas/PaymentType"
        arbiter:
          type: string
          description: Arbiter address for escrow (optional override)
        release_time:
          type: integer
          format: int64
          description: Unix timestamp for release
        payee:
          type: string
          description: Payee address (0x-prefixed)
        invoice_id:
          type: string
          format: uint64
          description: Invoice ID if payment_type is INVOICE
        invoice_payment_type:
          type: string
          enum:
            - DIRECT
            - ESCROW
          description: Payment type for the invoice (DIRECT/ESCROW)
    PaymentRequirements:
      type: object
      properties:
        scheme:
          type: string
        network:
          type: string
        maxAmountRequired:
          type: string
        resource:
          type: string
        description:
          type: string
        payTo:
          type: string
        maxTimeoutSeconds:
          type: integer
        asset:
          type: string
        extra:
          $ref: "#/components/schemas/PaymentExtra"
    X402VerifyRequest:
      type: object
      required:
        - x402Version
        - paymentHeader
        - paymentRequirements
      properties:
        x402Version:
          type: integer
        paymentHeader:
          type: string
        paymentRequirements:
          $ref: "#/components/schemas/PaymentRequirements"
    X402VerifyResponse:
      type: object
      properties:
        isValid:
          type: boolean
          description: Whether the payment authorization is valid
        invalidReason:
          type: string
          description: Reason for invalidity (omitted if valid)
        payer:
          type: string
          description: 0x-prefixed payer wallet address
    X402SettleRequest:
      type: object
      required:
        - x402Version
        - paymentHeader
        - paymentRequirements
      properties:
        x402Version:
          type: integer
        paymentHeader:
          type: string
        paymentRequirements:
          $ref: "#/components/schemas/PaymentRequirements"
    X402SettleResponse:
      type: object
      properties:
        success:
          type: boolean
          description: Whether settlement was successful
        errorReason:
          type: string
          description: "Reason for failure (only if success: false)"
        transaction:
          type: string
          description: Blockchain transaction hash (0x-prefixed)
        network:
          type: string
          description: Network in CAIP-2 format (e.g., eip155:84532)
        payer:
          type: string
          description: 0x-prefixed payer wallet address
    X402SupportedResponse:
      type: object
      properties:
        kinds:
          type: array
          items:
            type: object
            properties:
              x402Version:
                type: integer
              scheme:
                type: string
              network:
                type: string
        extensions:
          type: array
          description: Supported x402 extensions
          items:
            type: string
        signers:
          type: object
          description: Map of CAIP-2 patterns to signer addresses
          additionalProperties:
            type: array
            items:
              type: string
    GetEscrowResponse:
      type: object
      properties:
        escrowId:
          type: string
        payer:
          type: string
        payee:
          type: string
        amount:
          type: string
        arbiter:
          type: string
        releaseTime:
          type: integer
          format: int64
        status:
          type: string
          description: ACTIVE, RELEASED, REFUNDED
    EscrowActionRequest:
      type: object
      properties:
        network:
          type: string
    EscrowActionResponse:
      type: object
      properties:
        success:
          type: boolean
        errorReason:
          type: string
        transaction:
          type: string
        network:
          type: string
    Error:
      type: object
      properties:
        code:
          type: string
        message:
          type: string
    Invoice:
      type: object
      properties:
        invoice_id:
          type: string
          format: uint64
        merchant:
          type: string
        payer:
          type: string
        amount:
          type: string
        paid_amount:
          type: string
        due_date:
          type: integer
          format: int64
        created_at:
          type: integer
          format: int64
        payment_type:
          type: string
          enum:
            - DIRECT
            - ESCROW
        status:
          type: string
          enum:
            - UNSPECIFIED
            - PENDING
            - PARTIALLY_PAID
            - PAID
            - CANCELLED
            - EXPIRED
        metadata_uri:
          type: string
    CreateInvoiceRequest:
      type: object
      required:
        - amount
        - due_date
        - payment_type
      properties:
        merchant:
          type: string
          description: 0x-prefixed Merchant address (optional, defaults to backend)
          pattern: ^0x[a-fA-F0-9]{40}$
        amount:
          type: string
        payer:
          type: string
        due_date:
          type: integer
          format: int64
        payment_type:
          type: string
          enum:
            - DIRECT
            - ESCROW
        metadata_uri:
          type: string
    InvoiceResponse:
      type: object
      properties:
        invoice:
          $ref: "#/components/schemas/Invoice"
    InvoiceListResponse:
      type: object
      properties:
        invoices:
          type: array
          items:
            $ref: "#/components/schemas/Invoice"
        next_page_token:
          type: string
