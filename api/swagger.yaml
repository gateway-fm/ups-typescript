swagger: "2.0"
info:
  title: x402 UPS API
  version: 1.0.0
  description: x402 Universal Payments SDK API
basePath: /api/v1
schemes:
  - http
consumes:
  - application/json
produces:
  - application/json

securityDefinitions:
  BearerAuth:
    type: apiKey
    name: Authorization
    in: header

paths:
  # Health
  /health:
    get:
      summary: Health check
      operationId: healthCheck
      tags: [Health]
      responses:
        200:
          description: Service is healthy
          schema:
            $ref: "#/definitions/HealthResponse"

  # Auth
  /auth/connect:
    post:
      summary: Connect (unified auth) - creates user if new, authenticates if existing
      operationId: connectUser
      tags: [Auth]
      parameters:
        - name: body
          in: body
          required: true
          schema:
            $ref: "#/definitions/ConnectRequest"
      responses:
        200:
          description: Existing user authenticated
          schema:
            $ref: "#/definitions/ConnectResponse"
        201:
          description: New user created and authenticated
          schema:
            $ref: "#/definitions/ConnectResponse"
        401:
          description: Authentication failed
          schema:
            $ref: "#/definitions/Error"

  /auth/refresh:
    post:
      summary: Refresh session token
      description: Returns a new session token with extended expiry. Requires valid existing token.
      operationId: refreshToken
      tags: [Auth]
      security:
        - BearerAuth: []
      responses:
        200:
          description: Token refreshed successfully
          schema:
            $ref: "#/definitions/RefreshResponse"
        401:
          description: Invalid or expired token
          schema:
            $ref: "#/definitions/Error"

  /auth/register:
    post:
      summary: Register new user with wallet (deprecated - use /auth/connect)
      operationId: registerUser
      deprecated: true
      tags: [Auth]
      parameters:
        - name: body
          in: body
          required: true
          schema:
            $ref: "#/definitions/RegisterRequest"
      responses:
        201:
          description: User registered
          schema:
            $ref: "#/definitions/AuthResponse"
        400:
          description: Invalid input
          schema:
            $ref: "#/definitions/Error"

  /auth/login:
    post:
      summary: Authenticate with wallet signature (deprecated - use /auth/connect)
      operationId: loginUser
      deprecated: true
      tags: [Auth]
      parameters:
        - name: body
          in: body
          required: true
          schema:
            $ref: "#/definitions/LoginRequest"
      responses:
        200:
          description: Authentication successful
          schema:
            $ref: "#/definitions/AuthResponse"
        401:
          description: Authentication failed
          schema:
            $ref: "#/definitions/Error"

  # Users
  /users/me:
    get:
      summary: Get current user
      operationId: getCurrentUser
      tags: [Users]
      security:
        - BearerAuth: []
      responses:
        200:
          description: User details
          schema:
            $ref: "#/definitions/UserResponse"
        401:
          description: Unauthorized
          schema:
            $ref: "#/definitions/Error"

  # Accounts
  /accounts:
    post:
      summary: Create SmartAccount
      description: |
        Creates a new Smart Account for the authenticated user. 
        Users can create multiple accounts using different salts - each unique owner+salt combination 
        produces a distinct account address. If an account with the same owner+salt already exists, 
        the existing account is returned (idempotent behavior).
      operationId: createAccount
      tags: [Accounts]
      security:
        - BearerAuth: []
      parameters:
        - name: body
          in: body
          required: true
          schema:
            $ref: "#/definitions/CreateAccountRequest"
      responses:
        201:
          description: Account created
          schema:
            $ref: "#/definitions/AccountResponse"
        400:
          description: Invalid input
          schema:
            $ref: "#/definitions/Error"
        401:
          description: Unauthorized
          schema:
            $ref: "#/definitions/Error"

    get:
      summary: List user accounts
      operationId: listAccounts
      tags: [Accounts]
      security:
        - BearerAuth: []
      responses:
        200:
          description: List of accounts
          schema:
            $ref: "#/definitions/AccountListResponse"
        401:
          description: Unauthorized
          schema:
            $ref: "#/definitions/Error"

  /accounts/{id}:
    get:
      summary: Get account by ID
      operationId: getAccount
      tags: [Accounts]
      security:
        - BearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          type: string
          format: uuid
      responses:
        200:
          description: Account details
          schema:
            $ref: "#/definitions/AccountResponse"
        404:
          description: Account not found
          schema:
            $ref: "#/definitions/Error"
        401:
          description: Unauthorized
          schema:
            $ref: "#/definitions/Error"

  /accounts/predict:
    post:
      summary: Predict SmartAccount address
      operationId: predictAccountAddress
      tags: [Accounts]
      security:
        - BearerAuth: []
      parameters:
        - name: body
          in: body
          required: true
          schema:
            $ref: "#/definitions/PredictAddressRequest"
      responses:
        200:
          description: Predicted address
          schema:
            $ref: "#/definitions/PredictAddressResponse"
        400:
          description: Invalid input
          schema:
            $ref: "#/definitions/Error"
        401:
          description: Unauthorized
          schema:
            $ref: "#/definitions/Error"

  # x402 Protocol (Public - No Auth)
  /x402/verify:
    post:
      summary: Verify payment signature
      operationId: x402Verify
      tags: [x402]
      parameters:
        - name: body
          in: body
          required: true
          schema:
            $ref: "#/definitions/X402VerifyRequest"
      responses:
        200:
          description: Verification result
          schema:
            $ref: "#/definitions/X402VerifyResponse"
        400:
          description: Invalid input
          schema:
            $ref: "#/definitions/Error"

  /x402/settle:
    post:
      summary: Settle payment on-chain
      operationId: x402Settle
      tags: [x402]
      parameters:
        - name: body
          in: body
          required: true
          schema:
            $ref: "#/definitions/X402SettleRequest"
      responses:
        200:
          description: Settlement result
          schema:
            $ref: "#/definitions/X402SettleResponse"
        400:
          description: Invalid input
          schema:
            $ref: "#/definitions/Error"

  /x402/supported:
    get:
      summary: Get supported payment schemes
      operationId: x402GetSupported
      tags: [x402]
      responses:
        200:
          description: Supported schemes
          schema:
            $ref: "#/definitions/X402SupportedResponse"

  # Escrow
  /x402/escrow/{escrowId}:
    get:
      summary: Get escrow details
      operationId: getEscrow
      tags: [x402, Escrow]
      parameters:
        - name: escrowId
          in: path
          required: true
          type: string
          description: "Escrow ID (hex string)"
      responses:
        200:
          description: Escrow details
          schema:
            $ref: "#/definitions/GetEscrowResponse"
        404:
          description: Escrow not found
          schema:
            $ref: "#/definitions/Error"

  /x402/escrow/{escrowId}/release:
    post:
      summary: Release escrow funds
      operationId: releaseEscrow
      tags: [x402, Escrow]
      security:
        - BearerAuth: []
      parameters:
        - name: escrowId
          in: path
          required: true
          type: string
        - name: body
          in: body
          schema:
            $ref: "#/definitions/EscrowActionRequest"
      responses:
        200:
          description: Release result
          schema:
            $ref: "#/definitions/EscrowActionResponse"
        401:
          description: Unauthorized
        403:
          description: Forbidden (Not arbiter)
          schema:
            $ref: "#/definitions/Error"

  /x402/escrow/{escrowId}/refund:
    post:
      summary: Refund escrow funds
      operationId: refundEscrow
      tags: [x402, Escrow]
      security:
        - BearerAuth: []
      parameters:
        - name: escrowId
          in: path
          required: true
          type: string
        - name: body
          in: body
          schema:
            $ref: "#/definitions/EscrowActionRequest"
      responses:
        200:
          description: Refund result
          schema:
            $ref: "#/definitions/EscrowActionResponse"
        401:
          description: Unauthorized
        403:
          description: Forbidden (Not arbiter)
          schema:
            $ref: "#/definitions/Error"

definitions:
  # Health
  HealthResponse:
    type: object
    properties:
      status:
        type: string
      timestamp:
        type: string
        format: date-time

  # Auth
  RegisterRequest:
    type: object
    required: [wallet_address, signature, message]
    properties:
      wallet_address:
        type: string
        description: "0x-prefixed Ethereum address"
      signature:
        type: string
        description: "0x-prefixed EIP-191 signature"
      message:
        type: string

  LoginRequest:
    type: object
    required: [wallet_address, signature, message]
    properties:
      wallet_address:
        type: string
      signature:
        type: string
      message:
        type: string

  ConnectRequest:
    type: object
    required: [wallet_address, signature, message]
    properties:
      wallet_address:
        type: string
        description: "0x-prefixed Ethereum address"
      signature:
        type: string
        description: "0x-prefixed EIP-191 signature"
      message:
        type: string

  ConnectResponse:
    type: object
    properties:
      user:
        $ref: "#/definitions/User"
      token:
        type: string
      expires_at:
        type: string
        format: date-time
      is_new_user:
        type: boolean
        description: "True if a new user was created, false if existing user was authenticated"

  AuthResponse:
    type: object
    properties:
      user:
        $ref: "#/definitions/User"
      token:
        type: string
      expires_at:
        type: string
        format: date-time

  RefreshResponse:
    type: object
    properties:
      token:
        type: string
        description: "New JWT token"
      expires_at:
        type: string
        format: date-time
        description: "Token expiration time"

  # User
  User:
    type: object
    properties:
      id:
        type: string
        format: uuid
      wallet_address:
        type: string
      status:
        type: string
      created_at:
        type: string
        format: date-time

  UserResponse:
    type: object
    properties:
      user:
        $ref: "#/definitions/User"

  # Account
  CreateAccountRequest:
    type: object
    required: [owner_address, salt]
    properties:
      owner_address:
        type: string
        description: "0x-prefixed EOA address that will own the Smart Account"
      salt:
        type: string
        description: "0x-prefixed 32-byte salt. Different salts allow creation of multiple accounts for the same owner. Same owner+salt combination is idempotent."

  Account:
    type: object
    properties:
      id:
        type: string
        format: uuid
      owner_address:
        type: string
      wallet_address:
        type: string
      status:
        type: string
      kyc_level:
        type: integer
      user_id:
        type: string
        format: uuid
      created_at:
        type: string
        format: date-time

  AccountResponse:
    type: object
    properties:
      account:
        $ref: "#/definitions/Account"
      tx_hash:
        type: string

  AccountListResponse:
    type: object
    properties:
      accounts:
        type: array
        items:
          $ref: "#/definitions/Account"

  PredictAddressRequest:
    type: object
    required: [owner_address, salt]
    properties:
      owner_address:
        type: string
      salt:
        type: string

  PredictAddressResponse:
    type: object
    properties:
      wallet_address:
        type: string

  # x402
  PaymentType:
    type: string
    enum: [UNSPECIFIED, DIRECT, ESCROW]

  PaymentExtra:
    type: object
    properties:
      name:
        type: string
      version:
        type: string
      payment_type:
        $ref: "#/definitions/PaymentType"
      arbiter:
        type: string
        description: "Arbiter address for escrow (optional override)"
      release_time:
        type: integer
        format: int64
        description: "Unix timestamp for release"

  PaymentRequirements:
    type: object
    properties:
      scheme:
        type: string
      network:
        type: string
      maxAmountRequired:
        type: string
      resource:
        type: string
      description:
        type: string
      payTo:
        type: string
      maxTimeoutSeconds:
        type: integer
      asset:
        type: string
      extra:
        $ref: "#/definitions/PaymentExtra"

  X402VerifyRequest:
    type: object
    required: [x402Version, paymentHeader, paymentRequirements]
    properties:
      x402Version:
        type: integer
      paymentHeader:
        type: string
      paymentRequirements:
        $ref: "#/definitions/PaymentRequirements"

  X402VerifyResponse:
    type: object
    properties:
      isValid:
        type: boolean
        description: "Whether the payment authorization is valid"
      invalidReason:
        type: string
        description: "Reason for invalidity (omitted if valid)"
      payer:
        type: string
        description: "0x-prefixed payer wallet address"

  X402SettleRequest:
    type: object
    required: [x402Version, paymentHeader, paymentRequirements]
    properties:
      x402Version:
        type: integer
      paymentHeader:
        type: string
      paymentRequirements:
        $ref: "#/definitions/PaymentRequirements"

  X402SettleResponse:
    type: object
    properties:
      success:
        type: boolean
        description: "Whether settlement was successful"
      errorReason:
        type: string
        description: "Reason for failure (only if success: false)"
      transaction:
        type: string
        description: "Blockchain transaction hash (0x-prefixed)"
      network:
        type: string
        description: "Network in CAIP-2 format (e.g., eip155:84532)"
      payer:
        type: string
        description: "0x-prefixed payer wallet address"

  X402SupportedResponse:
    type: object
    properties:
      kinds:
        type: array
        items:
          type: object
          properties:
            x402Version:
              type: integer
            scheme:
              type: string
            network:
              type: string
      extensions:
        type: array
        description: "Supported x402 extensions"
        items:
          type: string
      signers:
        type: object
        description: "Map of CAIP-2 patterns to signer addresses"
        additionalProperties:
          type: array
          items:
            type: string

  # Escrow
  GetEscrowResponse:
    type: object
    properties:
      escrowId:
        type: string
      payer:
        type: string
      payee:
        type: string
      amount:
        type: string
      arbiter:
        type: string
      releaseTime:
        type: integer
        format: int64
      status:
        type: string
        description: "ACTIVE, RELEASED, REFUNDED"

  EscrowActionRequest:
    type: object
    properties:
      network:
        type: string

  EscrowActionResponse:
    type: object
    properties:
      success:
        type: boolean
      errorReason:
        type: string
      transaction:
        type: string
      network:
        type: string

  # Errors
  Error:
    type: object
    properties:
      code:
        type: string
      message:
        type: string
